

### 1. ğŸ§‘â€ğŸ¨ â€œæˆ‘â€ (å‰ç«¯æ€»è´Ÿè´£)



- **æ ¸å¿ƒä»»åŠ¡**: å®šä¹‰APIå¥‘çº¦ï¼Œå¹¶æ¶ˆè´¹Bã€Cçš„APIæ¥æ„å»ºUIã€‚
- **â€œæˆ‘â€çš„è¾“å‡º / (Bã€Cçš„è¾“å…¥)**: `API.md` - APIæ¥å£è§„èŒƒæ–‡æ¡£
- **â€œæˆ‘â€çš„è¾“å…¥ / (Bã€Cçš„è¾“å‡º)**: ä¸¤ä¸ª HTTP API æœåŠ¡ã€‚



#### 1.1. â€œæˆ‘â€å¿…é¡»æä¾›çš„ `API.md` è§„èŒƒ (Bã€Cçš„å¼€å‘æŒ‡å—)




---

##### A. åŒå­¦B (åç«¯-ä¸») å¿…é¡»å®ç°çš„æ¥å£

- **Host**: `http://db-app:5000`
- **CORS**: å¿…é¡»å¯ç”¨ `Access-Control-Allow-Origin: *` (åŒå­¦Béœ€åœ¨ Flask ä¸­é…ç½® `flask-cors`)

---

###### [æ¥å£ 1] äº¤äº’å¼æŸ¥è¯¢

- **Endpoint**: `POST /api/query`

- **ç”¨é€”**: â€œäº¤äº’å¼æŸ¥è¯¢é¡µé¢â€ï¼ŒæŒ‰éœ€æŸ¥è¯¢è¿‡è½¦æ˜ç»†ã€‚

- **Request Body (JSON):**

- ```json
  {
    "kkmc": "å¡å£A", // (å¯é€‰) å¡å£åç§°
    "hphm": "ç²¤B",     // (å¯é€‰) è½¦ç‰Œå·, æ”¯æŒå‰ç¼€
    "startTime": "2025-11-01 00:00:00", // (å¯é€‰)
    "endTime": "2025-11-01 23:59:59", // (å¯é€‰)
    "page": 1,        // (å¿…é€‰)
    "limit": 20       // (å¿…é€‰)
  }
  ```

  


  - **Response Body (JSON):**

    ```json
    {
      "code": 200,
      "msg": "success",
      "data": {
        "total": 1024, // æ€»è®°å½•æ•° (ç”¨äºåˆ†é¡µ)
        "records": [   // å½“å‰é¡µçš„æ•°æ® (å­—æ®µéœ€å‚è€ƒ äº¤é€šæµé‡æ•°æ®å­—æ®µè¯´æ˜.png)
          { "GCXH": 1, "XZQHMC": "...", "KKMC": "...", "HPHM": "ç²¤BXXXXX", "CLLX": "K33", "CPFSF": "å¹¿ä¸œ", "GCSJ": "2025-11-01 00:01:00" }
        ]
      }
    }
    ```

    

*(æ³¨æ„ï¼šä¸ºä¿æŒæ ¼å¼ç»Ÿä¸€ï¼Œå°† Response å°è£…åœ¨äº† `data` å¯¹è±¡ä¸­ï¼Œå¹¶é‡å‘½åäº†æ•°æ®åˆ—è¡¨ä¸º `records`)*

-----

###### [æ¥å£ 2] å¤§å±ï¼šå¡å£æµé‡ Top 10

  - **Endpoint**: `GET /api/stats/kkmc_count`

  - **ç”¨é€”**: â€œæ•°æ®å¤§å±â€ - å¡å£æ’åæŸ±çŠ¶å›¾ã€‚

  - **Response Body (JSON):**

    ```json
    {
      "code": 200,
      "msg": "success",
      "data": [
        { "name": "å¡å£A", "value": 9001 },
        { "name": "å¡å£B", "value": 8050 },
        { "name": "å¡å£C", "value": 7300 }
        // ... (B è´Ÿè´£æ’åºå’Œ Top 10)
      ]
    }
    ```


-----

###### [æ¥å£ 3] å¤§å±ï¼š24å°æ—¶æµé‡æ›²çº¿

  - **Endpoint**: `GET /api/stats/hour_count`

  - **ç”¨é€”**: â€œæ•°æ®å¤§å±â€ - Echarts æŠ˜çº¿å›¾ã€‚

  - **Response Body (JSON):**

    ```json
    {
      "code": 200,
      "msg": "success",
      "data": {
        "hours": ["00:00", "01:00", "02:00", "03:00", ..., "23:00"],
        "data": [120, 200, 150, 300, ..., 150]
      }
    }
    ```


-----

###### [æ¥å£ 4] å¤§å±ï¼šè½¦è¾†æ¥æºåœ°å›¾ç‚®

  - **Endpoint**: `GET /api/stats/map_data`

  - **ç”¨é€”**: â€œæ•°æ®å¤§å±â€ - Echarts åœ°å›¾ç‚®/é¥¼å›¾æ•°æ®æº (B éœ€æŒ‰ `CPFSF` å­—æ®µèšåˆ)ã€‚

  - \- **(v1.1 æ›´æ–°)**: åŒå­¦B å¿…é¡»æŒ‰ Kafka `traffic-raw` ä¸»é¢˜ ä¸­çš„ **`PROVINCE`** å­—æ®µ (ç¬¬9å­—æ®µ) è¿›è¡Œèšåˆã€‚

  - **Response Body (JSON):**

    ```json
    {
      "code": 200,
      "msg": "success",
      "data": [
        { "name": "å¹¿ä¸œ", "value": 15000 },
        { "name": "æ¹–å—", "value": 8000 },
        { "name": "æ¹–åŒ—", "value": 5200 }
        // ... (B è´Ÿè´£èšåˆä¸æ’åº)
      ]
    }
    ```

###### [æ¥å£ 5] å¤§å±ï¼šè½¦å‹å æ¯”åˆ†æ (v1.2 æ–°å¢)

  - **Endpoint**: `GET /api/stats/vehicle_type`

  - **ç”¨é€”**: â€œæ•°æ®å¤§å±â€ - **è½¦è¾†ç±»å‹** å æ¯”é¥¼å›¾/ç¯å½¢å›¾ã€‚

  - **(v1.2 æ–°å¢)**: åŒå­¦B å¿…é¡»æŒ‰ Kafka `traffic-raw` ä¸»é¢˜ ä¸­çš„ **`VEHICLE_TYPE_NAME`** å­—æ®µ (ç¬¬12å­—æ®µ) è¿›è¡Œèšåˆã€‚

  - **Response Body (JSON):**

    ```json
    {
      "code": 200,
      "msg": "success",
      "data": [
        { "name": "å°å‹å®¢è½¦", "value": 90000 },
        { "name": "è´§è½¦", "value": 25000 },
        { "name": "å¤§å‹å®¢è½¦", "value": 12000 },
        { "name": "å…¶ä»–è½¦å‹", "value": 5000 }
      ]
    }
    ```

    

-----

-----

##### B. åŒå­¦C (ç®—æ³•-è¾…) å¿…é¡»å®ç°çš„æ¥å£

  - **Host**: `http://pipeline-algo:5001`
  - **CORS**: å¿…é¡»å¯ç”¨ `Access-Control-Allow-Origin: *` (C éœ€åœ¨ Flask ä¸­é…ç½® `flask-cors`)

-----

###### [æ¥å£ 6] å¤§å±ï¼šå®æ—¶å¥—ç‰Œè½¦å‘Šè­¦

  - **Endpoint**: `GET /api/warnings/realtime`

  - **ç”¨é€”**: â€œæ•°æ®å¤§å±â€ - å®æ—¶å‘Šè­¦æ»šåŠ¨åˆ—è¡¨ã€‚

  - **æŠ€æœ¯æ ˆ**: C éœ€ä½¿ç”¨ Flink æ¶ˆè´¹ Kafkaï¼Œå®æ—¶è®¡ç®—ï¼Œå¹¶å°†ç»“æœ Sink åˆ° Redisï¼Œæ­¤ API è¯»å– Redis æä¾›æ•°æ®ã€‚

  - **Response Body (JSON):**

    ```json
    {
      "code": 200,
      "msg": "success",
      "data": [
        "è½¦ç‰Œ [ç²¤BXXXXX] ç–‘ä¼¼å¥—ç‰Œ: 3åˆ†é’Ÿå†…ä» [å¡å£A] ç§»åŠ¨åˆ° [å¡å£B]",
        "è½¦ç‰Œ [ç²¤CYYYYY] ç–‘ä¼¼å¥—ç‰Œ: 2åˆ†é’Ÿå†…ä» [å¡å£C] ç§»åŠ¨åˆ° [å¡å£D]"
      ]
    }
    ```

-----

###### [æ¥å£ 7] å¤§å±ï¼šæœªæ¥æµé‡é¢„æµ‹

  - **Endpoint**: `GET /api/predict/flow`

  - **ç”¨é€”**: â€œæ•°æ®å¤§å±â€ - é¢„æµ‹æ¨¡å—ã€‚

  - **Request Params:**

    - `kkmc` (å¯é€‰): é¢„æµ‹ç‰¹å®šå¡å£ (e.g., `?kkmc=å¡å£A`)
    - `hour` (å¿…é€‰): é¢„æµ‹çš„å°æ—¶ (0-23) (e.g., `?hour=14`)

  - **Response Body (JSON):**

    ```json
    {
      "code": 200,
      "msg": "success",
      "data": {
        "kkmc": "å¡å£A", // (è‹¥ä¸ä¼ kkmc, åˆ™è¿”å› "å…¨å¸‚")
        "hour": 14,
        "predicted_flow": 520 // é¢„æµ‹å€¼
      }
    }
    ```



------



### 2. ğŸ§‘â€ğŸ”§ åŒå­¦A (æ•°æ®ç®¡é“å·¥)



- **æ ¸å¿ƒä»»åŠ¡**: `Python -> Flume -> Kafka`ï¼Œä¸ºBå’ŒCæä¾›ç¨³å®šçš„æ•°æ®æºã€‚
- **ä¸Šæ¸¸/è¾“å…¥**:
  1. **æ–‡ä»¶**: ä½ ä¸Šä¼ çš„ `202312` å’Œ `202401` æ–‡ä»¶å¤¹ï¼ˆéœ€åˆå¹¶ä¸º `master_data.csv`ï¼‰ã€‚
  2. **é€»è¾‘**: `simulate.py` è„šæœ¬ï¼Œç”¨äºæ›¿æ¢æ—¶é—´æˆ³å’Œæ§åˆ¶é€Ÿç‡ã€‚
  3. **é…ç½®**: `flume-kafka.conf`ã€‚
- **ä¸‹æ¸¸/è¾“å‡º**: åŒå­¦Bå’ŒåŒå­¦Cã€‚
- **äº¤ä»˜ç‰©æ¸…å•**:
  1. `simulate.py` è„šæœ¬ (è¿è¡Œåœ¨ `pipeline-algo`)
  2. `flume-kafka.conf` (è¿è¡Œåœ¨ `pipeline-algo`)
  3. ä¸€ä¸ªåœ¨ `pipeline-algo` ä¸Š**æŒç»­è¿è¡Œ**çš„ Kafka `traffic-raw` ä¸»é¢˜ã€‚



#### 2.1. åŒå­¦Açš„è¾“å‡ºè§„èŒƒ (Bã€Cçš„è¾“å…¥è§„èŒƒ)



è¿™æ˜¯Aå¿…é¡»å‘Bå’ŒCæ‰¿è¯ºçš„**æ•°æ®å¥‘çº¦**ï¼š

- **Kafka æœåŠ¡å™¨**: `pipeline-algo:9092`

- **Kafka Topic**: `traffic-raw`

- **æ•°æ®æ ¼å¼**: **Raw String**

- **åˆ†éš”ç¬¦**: **`\t` (Tabåˆ¶è¡¨ç¬¦)**

- æ•°æ® Schema (å…± 12 ä¸ªå­—æ®µ):

  [GCXH]\t[XZQHMC]\t[KKMC]\t[FXLX]\t[GCSJ]\t[HPZL]\t[HPHM]\t[CLPPXH]\t**[PROVINCE]\t[IS_WEEKEND]\t[IS_PEAK_HOUR]\t[VEHICLE_TYPE_NAME]**

- **å…³é”®è¯´æ˜**:

  - `[GCSJ]` å­—æ®µ (è¿‡è½¦æ—¶é—´) **ä¸å†æ˜¯** `master_data.csv` é‡Œçš„å†å²æ—¶é—´ï¼Œè€Œæ˜¯è¢« `simulate.py` **æ›¿æ¢ä¸ºçš„å½“å‰æœåŠ¡å™¨æ—¶é—´** (æ ¼å¼: `YYYY-MM-DD HH:MM:SS`)ã€‚
  - æ‰€æœ‰å­—æ®µå‡ä¸ºå­—ç¬¦ä¸²ï¼ŒBå’ŒCåœ¨Flinkä¸­æ¶ˆè´¹æ—¶éœ€è¦è‡ªè¡Œè§£æã€‚

------



### 3. ğŸ§‘â€ğŸ’» åŒå­¦B (åç«¯ä¸å­˜å‚¨ - ä¸»)



- **æ ¸å¿ƒä»»åŠ¡**: `Kafka -> Flink -> MyCat`ï¼Œå¹¶æä¾›ä¸šåŠ¡ APIã€‚
- **ä¸Šæ¸¸/è¾“å…¥**:
  1. **Kafkaæµ**: åŒå­¦Açš„ `traffic-raw` ä¸»é¢˜ (å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ **2.1.èŠ‚** çš„è§„èŒƒè§£æ)ã€‚
  2. **APIè§„èŒƒ**: â€œæˆ‘â€ (å‰ç«¯) æä¾›çš„ `API.md` (å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ **1.1.AèŠ‚** çš„è§„èŒƒå®ç°)ã€‚
  3. **(å¯é€‰)** `master_data.csv`ï¼šç”¨äºæå–è½¦ç‰Œå‰ç¼€å’Œçœä»½çš„æ˜ å°„ï¼Œå­˜å…¥ `cp_map` å…¨å±€è¡¨ã€‚
- **ä¸‹æ¸¸/è¾“å‡º**: â€œæˆ‘â€ (å‰ç«¯)ã€‚
- **äº¤ä»˜ç‰©æ¸…å•**:
  1. **MySQL è™šæ‹ŸèŠ‚ç‚¹**: åœ¨ `db-app` ä¸Šè¿è¡Œ `3306` (ä¸») å’Œ `3307` (ä») ä¸¤ä¸ªMySQL 5.7å®ä¾‹ã€‚
  2. **MyCat é…ç½®**: `schema.xml` å’Œ `server.xml`ï¼Œå®ç°æŒ‰ `KKMC` åˆ†ç‰‡ã€‚
  3. **Flink Job**: `KafkaToMycat.java` (æˆ– Scala) é¡¹ç›®ï¼Œè¿è¡Œåœ¨ `pipeline-algo`ï¼Œå°† `traffic-raw` æ•°æ®å†™å…¥ MyCatã€‚
  4. **Flask API**: `app_B.py` (æˆ– Flaské¡¹ç›®)ï¼Œè¿è¡Œåœ¨ `db-app:5000`ã€‚



#### 3.1. åŒå­¦Bçš„è¾“å‡ºè§„èŒƒ (â€œæˆ‘â€çš„è¾“å…¥è§„èŒƒ)



- **API Host**: `http://db-app:5000`
- **CORS**: å¿…é¡»é…ç½®ä¸º `Access-Control-Allow-Origin: *`
- **æ¥å£**: å¿…é¡»**ä¸¥æ ¼ã€å®Œæ•´**åœ°å®ç° **1.1.AèŠ‚** ä¸­å®šä¹‰çš„æ‰€æœ‰æ¥å£ã€Request Body å’Œ Response Body æ ¼å¼ã€‚

------



### 4. ğŸ§‘â€ğŸ”¬ åŒå­¦C (ç®—æ³•ä¸é¢„è­¦ - è¾…)



- **æ ¸å¿ƒä»»åŠ¡**: `Kafka -> Flink -> Redis` (å®æ—¶å‘Šè­¦)ï¼Œ`Spark -> Flask` (ç¦»çº¿é¢„æµ‹)ã€‚
- **ä¸Šæ¸¸/è¾“å…¥**:
  1. **Kafkaæµ**: åŒå­¦Açš„ `traffic-raw` ä¸»é¢˜ (å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ **2.1.èŠ‚** çš„è§„èŒƒè§£æ)ã€‚
  2. **ç¦»çº¿æ•°æ®**: `master_data.csv` (ç”¨äº Spark ML è®­ç»ƒ)ã€‚
  3. **APIè§„èŒƒ**: â€œæˆ‘â€ (å‰ç«¯) æä¾›çš„ `API.md` (å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ **1.1.BèŠ‚** çš„è§„èŒƒå®ç°)ã€‚
- **ä¸‹æ¸¸/è¾“å‡º**: â€œæˆ‘â€ (å‰ç«¯)ã€‚
- **äº¤ä»˜ç‰©æ¸…å•**:
  1. **Flink Job**: `DetectTaopai.java` (æˆ– Scala) é¡¹ç›®ï¼Œè¿è¡Œåœ¨ `pipeline-algo`ï¼Œå°†å‘Šè­¦å­—ç¬¦ä¸²å†™å…¥ Redisã€‚
  2. **Redis è§„èŒƒ**:
     - **Host**: `pipeline-algo:6379`
     - **Key**: `traffic:warnings`
     - **Type**: `List` (Flink ä½¿ç”¨ `LPUSH` å†™å…¥)
  3. **Spark è„šæœ¬**: `train.py` (PySpark è„šæœ¬)ã€‚
  4. **æ¨¡å‹æ–‡ä»¶**: `traffic_model` (ä¿å­˜åœ¨ `pipeline-algo` æœåŠ¡å™¨ä¸Š)ã€‚
  5. **Flask API**: `app_C.py` (æˆ– Flaské¡¹ç›®)ï¼Œè¿è¡Œåœ¨ `pipeline-algo:5001`ã€‚



#### 4.1. åŒå­¦Cçš„è¾“å‡ºè§„èŒƒ (â€œæˆ‘â€çš„è¾“å…¥è§„èŒƒ)



- **API Host**: `http://pipeline-algo:5001`
- **CORS**: å¿…é¡»é…ç½®ä¸º `Access-Control-Allow-Origin: *`
- **æ¥å£**: å¿…é¡»**ä¸¥æ ¼ã€å®Œæ•´**åœ°å®ç° **1.1.BèŠ‚** ä¸­å®šä¹‰çš„æ‰€æœ‰æ¥å£ã€Request Params å’Œ Response Body æ ¼å¼ã€‚