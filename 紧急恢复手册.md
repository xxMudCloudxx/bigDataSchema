# ğŸš¨ ç´§æ€¥ç¾éš¾æ¢å¤æ‰‹å†Œ (Emergency Disaster Recovery Manual) - V3.0 Final

é€‚ç”¨åœºæ™¯ï¼š æœåŠ¡å™¨è¢«è¯¯åˆ ã€ç¯å¢ƒè¢«æå´©ã€é‡è£…ç³»ç»Ÿã€‚

æ¢å¤ç›®æ ‡ï¼š å¿«é€Ÿé‡å»ºè®¡ç®—ä¸å­˜å‚¨æœåŠ¡ï¼Œä¸åŒ…å«å†å²æ—§æ•°æ®ï¼ˆä¾é æ¨¡æ‹Ÿè„šæœ¬é‡æ–°ç”Ÿæˆæ•°æ®ï¼‰ã€‚

å‰ææ¡ä»¶ï¼š ä½ æ‰‹å¤´æ‹¥æœ‰ä¹‹å‰å¤‡ä»½çš„ .tar.gz å‹ç¼©åŒ…ï¼ˆå†…å«ä»£ç ã€é…ç½®å’Œè„šæœ¬ï¼‰ã€‚

------

## ğŸ“Š 0. æ ¸å¿ƒç‰ˆæœ¬çŸ©é˜µ (é‡å»ºåŸºå‡†)

**ä¸¥æ­£è­¦å‘Šï¼š** é‡è£…ç¯å¢ƒæ—¶ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹ç‰ˆæœ¬ï¼Œå¦åˆ™æœåŠ¡å°†æ— æ³•äº’é€šï¼

| **ç»„ä»¶**    | **å®¡è®¡ç¡®è®¤ç‰ˆæœ¬**       | **å¤‡æ³¨**                                      |
| ----------- | ---------------------- | --------------------------------------------- |
| **OS**      | Ubuntu 22.04           | Python 3.10 (ç³»ç»Ÿè‡ªå¸¦)                        |
| **Java**    | **OpenJDK 1.8.0_472**  | **å…³é”®ï¼** å¿…é¡»æ˜¯ Java 8ï¼Œå¦åˆ™ MyCat æ— æ³•å¯åŠ¨ |
| **MySQL**   | **5.7** (Docker)       | 8.0 ä¼šå¯¼è‡´ MyCat è¿æ¥å¤±è´¥                     |
| **Kafka**   | **2.4.1** (Scala 2.11) | ç»å…¸ç¨³å®šç‰ˆ                                    |
| **Flink**   | **1.13.6**             | é…åˆ Java 8                                   |
| **PySpark** | **4.0.1**              | ç”¨äºåŠ è½½é¢„æµ‹æ¨¡å‹                              |
| **Flask**   | è¿è¡Œç«¯å£ **5000**      | **ä¸è¦**æ”¹æˆ 8088ï¼Œå®¡è®¡æ˜¾ç¤ºå®é™…ç›‘å¬ä¸º 5000    |

------

## ğŸ› ï¸ ç¬¬ä¸€é˜¶æ®µï¼šæ¢å¤ `pipeline-algo` (è®¡ç®—èŠ‚ç‚¹)

**IPï¼š** `112.124.59.217` (å†…ç½‘: 172.18.179.176)

### 1. åŸºç¡€ç¯å¢ƒå¿«é€Ÿå¤åŸ

Bash

```
# 1. å®‰è£…åŸºç¡€ä¾èµ– (å®¡è®¡ç¡®è®¤ç¯å¢ƒä¸º OpenJDK 8)
sudo apt update
sudo apt install -y openjdk-8-jdk python3 python3-pip

# 2. ä¸Šä¼ å¹¶è§£å‹ä½ çš„å¤‡ä»½åŒ… (å‡è®¾æ–‡ä»¶åä¸º pipeline_algo_FINAL.tar.gz)
# è¿™ä¼šå°† /root/datapipe, /usr/local/flume ç­‰æ¢å¤åˆ°ä½
tar -xzvf pipeline_algo_FINAL.tar.gz -C /
```

### 2. æ¸…æ´—ä¸é‡å¯ä¸­é—´ä»¶ (ZK & Kafka)

Bash

```
# 1. æš´åŠ›æ¸…ç©ºæ•°æ®ç›®å½• (é˜²æ­¢æ—§æ—¥å¿—å¯¼è‡´å¯åŠ¨å¤±è´¥)
rm -rf /usr/local/kafka/data/*
rm -rf /usr/local/zookeeper/data/*

# 2. å¯åŠ¨ Zookeeper (ç«¯å£ 2181)
/usr/local/kafka/bin/zookeeper-server-start.sh -daemon /usr/local/kafka/config/zookeeper.properties

# 3. å¯åŠ¨ Kafka (ç«¯å£ 9092)
/usr/local/kafka/bin/kafka-server-start.sh -daemon /usr/local/kafka/config/server.properties

# 4. åˆ›å»º Topic (Traffic-Raw)
/usr/local/kafka/bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic traffic-raw
```

### 3. é‡å¯æ•°æ®ç®¡é“ (Flume + Simulate)

**ä¿®æ­£ç‚¹ï¼š** å®¡è®¡ç¡®è®¤æ¨¡æ‹Ÿè„šæœ¬è·¯å¾„ä¸º `/root/datapipe`ã€‚

Bash

```
# 1. å¯åŠ¨ Flume
nohup /usr/local/flume/bin/flume-ng agent -n a1 -c /usr/local/flume/conf -f /usr/local/flume/jobs/file2kafka.conf -Dflume.root.logger=INFO,console > flume.log 2>&1 &

# 2. å¯åŠ¨æ¨¡æ‹Ÿè„šæœ¬
cd /root/datapipe
nohup python3 6.simulate.py > /dev/null 2>&1 &
```

### 4. æäº¤ Flink è®¡ç®—ä»»åŠ¡

Bash

```
# 1. å¯åŠ¨ Flink é›†ç¾¤ (ç«¯å£ 8081)
/usr/local/flink/bin/start-cluster.sh

# 2. æäº¤ JAR åŒ… (è·¯å¾„ä¾æ®å¤‡ä»½ç»“æ„)
/usr/local/flink/bin/flink run -d -c com.traffic.job.KafkaToMyCatJob /tmp/project_backup/flink_jar/TrafficMonitor-1.0-SNAPSHOT.jar
```

------

## ğŸ—„ï¸ ç¬¬äºŒé˜¶æ®µï¼šæ¢å¤ `db-app` (å­˜å‚¨èŠ‚ç‚¹)

**IPï¼š** `121.196.226.161` (å†…ç½‘: 172.24.214.148)

### 1. åŸºç¡€ç¯å¢ƒå¤åŸ

Bash

```
# 1. å®‰è£… Docker & Python
sudo apt update
sudo apt install -y docker.io python3 python3-pip openjdk-8-jdk

# 2. ä¸Šä¼ å¹¶è§£å‹å¤‡ä»½åŒ…
tar -xzvf db_app_FINAL.tar.gz -C /
```

### 2. é‡å¯ç‰©ç†æ•°æ®åº“ (Docker)

**ä¿®æ­£ç‚¹ï¼š** å®¡è®¡ç¡®è®¤ MySQL ç‰ˆæœ¬ä¸º `5.7`ã€‚

Bash

```
# 1. å¯åŠ¨ä¸¤ä¸ªç©ºçš„ MySQL å®¹å™¨ (ç«¯å£ 3306, 3307)
docker run -d -p 3306:3306 --name mysql-n1 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7
docker run -d -p 3307:3306 --name mysql-n2 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7

# 2. ç­‰å¾… 10ç§’è®©å®¹å™¨å®Œå…¨å¯åŠ¨...

# 3. åˆ›å»ºç‰©ç†åº“ (traffic_db)
docker exec -i mysql-n1 mysql -uroot -p123456 -e "CREATE DATABASE traffic_db;"
docker exec -i mysql-n2 mysql -uroot -p123456 -e "CREATE DATABASE traffic_db;"
```

### 3. æ¢å¤ MyCat ä¸­é—´ä»¶

Bash

```
# 1. èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x /usr/local/mycat/bin/*

# 2. å¯åŠ¨ MyCat (ç«¯å£ 8066)
/usr/local/mycat/bin/mycat start
```

### 4. é‡å»ºè¡¨ç»“æ„ (Schema Initialization)

**å…³é”®ä¿®æ­£ï¼š** ä½¿ç”¨ Docker å›è¿æ³•å»ºè¡¨ï¼Œç¡®ä¿ 100% æˆåŠŸã€‚

Bash

```
# é€šè¿‡ Docker å®¹å™¨å†…çš„ MySQL å®¢æˆ·ç«¯è¿æ¥å®¿ä¸»æœº MyCat
docker exec -i mysql-n1 mysql -h 172.17.0.1 -P 8066 -u root -p123456 -D MYETCDB <<EOF
CREATE TABLE traffic_data (
    id VARCHAR(50) PRIMARY KEY,
    kkmc VARCHAR(50),
    hphm VARCHAR(20),
    gcsj DATETIME,
    fxlx VARCHAR(10),
    hpzl VARCHAR(10),
    clppxh VARCHAR(20),
    xzqhmc VARCHAR(50),
    province VARCHAR(10),
    is_weekend VARCHAR(5),
    is_peak_hour VARCHAR(5),
    vehicle_type_name VARCHAR(20)
);
EOF
```

### 5. æ¢å¤ Flask åç«¯

**ä¿®æ­£ç‚¹ï¼š** å®¡è®¡ç¡®è®¤ Flask è¿è¡Œåœ¨ `5000` ç«¯å£ï¼Œä¸”ä½¿ç”¨ `venv` è™šæ‹Ÿç¯å¢ƒã€‚

Bash

```
# 1. è¿›å…¥ä»£ç ç›®å½• (å·²ç”±å¤‡ä»½åŒ…æ¢å¤)
cd /home/student_d/backend/

# 2. ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒå¯åŠ¨ (æ— éœ€é‡æ–° pip install)
nohup venv/bin/python app_B.py > flask.log 2>&1 &
```

------

## ğŸš¦ ç¬¬ä¸‰é˜¶æ®µï¼šä¸€é”®éªŒè¯è„šæœ¬ (The "Red Button")

**è¯´æ˜ï¼š** ç¾éš¾æ¢å¤åï¼Œåˆ†åˆ«åœ¨ä¸¤å°æœºå™¨æ‰§è¡Œä»¥ä¸‹è„šæœ¬ã€‚å¦‚æœå…¨éƒ¨è¾“å‡º `[OK]` æˆ– `âœ…`ï¼Œåˆ™ç³»ç»Ÿå®Œå…¨å¤æ´»ã€‚

### è„šæœ¬ A: `pipeline-algo` éªŒè¯è„šæœ¬ (`check_algo.sh`)

Bash

```
#!/bin/bash
# ä¿å­˜ä¸º check_algo.sh å¹¶ chmod +x è¿è¡Œ

echo "==== Pipeline-Algo æ·±åº¦è‡ªæ£€ ===="

# 1. æ ¸å¿ƒè¿›ç¨‹æ£€æŸ¥
for proc in "zookeeper" "kafka" "file2kafka.conf" "simulate.py" "TaskManager"; do
    if pgrep -f "$proc" >/dev/null; then 
        echo -e "\033[32m[OK] $proc æ­£åœ¨è¿è¡Œ\033[0m"
    else 
        echo -e "\033[31m[ERROR] $proc æœªå¯åŠ¨!\033[0m"
    fi
done

# 2. æ•°æ®æºæ»šåŠ¨æ£€æŸ¥ (æ£€æŸ¥ /var/log/traffic.log)
if [ -f /var/log/traffic.log ]; then
    size1=$(stat -c%s /var/log/traffic.log)
    sleep 2
    size2=$(stat -c%s /var/log/traffic.log)
    if [ "$size2" -gt "$size1" ]; then
        echo -e "\033[32m[OK] æ•°æ®æºæ­£åœ¨ç”Ÿæˆ (Size: $size1 -> $size2)\033[0m"
    else
        echo -e "\033[31m[ERROR] æ•°æ®æºç–‘ä¼¼å¡æ­» (æ–‡ä»¶å¤§å°æœªå˜)\033[0m"
    fi
else
    echo -e "\033[31m[ERROR] æ—¥å¿—æ–‡ä»¶ /var/log/traffic.log ä¸å­˜åœ¨!\033[0m"
fi

# 3. Flink ä»»åŠ¡çŠ¶æ€
if /usr/local/flink/bin/flink list 2>/dev/null | grep -q "RUNNING"; then
    echo -e "\033[32m[OK] Flink ä»»åŠ¡çŠ¶æ€: RUNNING\033[0m"
else
    echo -e "\033[31m[ERROR] Flink ä»»åŠ¡æœªè¿è¡Œ!\033[0m"
fi
```

### è„šæœ¬ B: `db-app` éªŒè¯è„šæœ¬ (`check_db.sh`)

**å…³é”®ä¿®æ­£ï¼š** å·²é›†æˆ `docker exec` å›è¿éªŒè¯æ³•ã€‚

Bash

```
#!/bin/bash
# ä¿å­˜ä¸º check_db.sh å¹¶ chmod +x è¿è¡Œ

echo "==== DB-App æ·±åº¦è‡ªæ£€ ===="

# 1. å®¹å™¨æ£€æŸ¥
if docker ps | grep -q "mysql-n1" && docker ps | grep -q "mysql-n2"; then
    echo -e "\033[32m[OK] MySQL åŒå®¹å™¨è¿è¡Œæ­£å¸¸\033[0m"
else
    echo -e "\033[31m[ERROR] MySQL å®¹å™¨å¼‚å¸¸\033[0m"
fi

# 2. MyCat ç«¯å£æ£€æŸ¥
if netstat -ntlp | grep -q "8066"; then
    echo -e "\033[32m[OK] MyCat (8066) ç›‘å¬ä¸­\033[0m"
else
    echo -e "\033[31m[ERROR] MyCat ç«¯å£æœªå¯åŠ¨\033[0m"
fi

# 3. æ•°æ®è½åœ°éªŒè¯ (ä½¿ç”¨ Docker å›è¿æ³• - ç»ˆæéªŒè¯)
echo "æ­£åœ¨æ£€æŸ¥æ•°æ®å…¥åº“..."
# ä½¿ç”¨å®¿ä¸»æœº Docker ç½‘æ¡¥ IP 172.17.0.1
db_count=$(docker exec -i mysql-n1 mysql -h 172.17.0.1 -P 8066 -u root -p123456 -D MYETCDB -N -e "SELECT count(*) FROM traffic_data;" 2>/dev/null)

if [[ "$db_count" =~ ^[0-9]+$ ]]; then
    if [ "$db_count" -gt 0 ]; then
        echo -e "\033[32m[OK] MyCat è¯»å†™æ­£å¸¸ï¼Œå½“å‰æ•°æ®é‡: $db_count\033[0m"
    else
        echo -e "\033[33m[WARNING] MyCat è¿æ¥æˆåŠŸä½†è¡¨ä¸ºç©º (æ•°æ®é‡: 0)ï¼Œè¯·æ£€æŸ¥ pipeline-algo\033[0m"
    fi
else
    echo -e "\033[31m[ERROR] MyCat æŸ¥è¯¢å¤±è´¥! è¯·æ‰‹åŠ¨æ‰§è¡Œ docker exec å‘½ä»¤æ’æŸ¥\033[0m"
fi

# 4. Flask API æ£€æŸ¥ (ç«¯å£ 5000)
if netstat -ntlp | grep -q "5000"; then
    echo -e "\033[32m[OK] Flask API (5000) ç›‘å¬ä¸­\033[0m"
else
    echo -e "\033[31m[ERROR] Flask API æœªå¯åŠ¨ (åº”ä¸º 5000 ç«¯å£)\033[0m"
fi
```

# æœåŠ¡å™¨çŠ¶æ€è„šæœ¬è¯´æ˜

ä»“åº“ä¸­çš„â€œæœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥â€æ–‡ä»¶å¤¹ä¸­ä¿å­˜äº†æ‰€æœ‰éªŒè¯è„šæœ¬ã€‚

éœ€è¦ä¿è¯æŒ‰ç…§çš„æœåŠ¡ç‰ˆæœ¬å’ŒåŸç‰ˆæœ¬å¯¹å¾—ä¸Šã€‚

## pipeline-algo-srver

```
========== æœåŠ¡å™¨æ·±åº¦å®¡è®¡æŠ¥å‘Š V2.0: iZsf43us332zrtZ ==========
æ—¶é—´: Fri Dec  5 12:41:51 AM CST 2025
IPåœ°å€: 172.18.179.176 

[1] ç¯å¢ƒå˜é‡æ·±åº¦æ£€æŸ¥ (Environment)
JAVA_HOME (Current): 
CLASSPATH (Current): 
JAVA_HOME (Detected): /usr/lib/jvm/java-8-openjdk-amd64/jre/ (è‡ªåŠ¨æ¢æµ‹)

[2] æ ¸å¿ƒç»„ä»¶ç‰ˆæœ¬æ£€æŸ¥ (Version Check)
Java ç‰ˆæœ¬: 1.8.0_472
Python3 ç‰ˆæœ¬: 3.10.12
Kafka (JaråŒ…æ¨æ–­): kafka_2.11-2.4.1.jar
Zookeeper (JaråŒ…æ¨æ–­): zookeeper-3.5.7.jar
Flume ç‰ˆæœ¬: Flume 1.9.0
Flink ç‰ˆæœ¬: Version: 1.13.6, Commit ID: b2ca390
Docker: æœªå®‰è£…

[3] Python å…³é”®ä¾èµ–ç‰ˆæœ¬ (Pip Freeze)
æœªæ‰¾åˆ°å…³é”® Python åŒ…

[4] æ ¸å¿ƒç«¯å£ç›‘å¬å¤æŸ¥
tcp6       0      0 127.0.0.1:9092          :::*                    LISTEN      68505/java          
tcp6       0      0 :::2181                 :::*                    LISTEN      68141/java          

========== å®¡è®¡ V2.0 ç»“æŸ ==========

```

## db-app

```
========== æœåŠ¡å™¨æ·±åº¦å®¡è®¡æŠ¥å‘Š V2.0: iZbp140579b0uunbxve5tgZ ==========
æ—¶é—´: Fri Dec  5 12:40:14 AM CST 2025
IPåœ°å€: 172.24.214.148 172.17.0.1 

[1] ç¯å¢ƒå˜é‡æ·±åº¦æ£€æŸ¥ (Environment)
JAVA_HOME (Current): 
CLASSPATH (Current): 
JAVA_HOME (Detected): /usr/lib/jvm/java-8-openjdk-amd64/jre/ (è‡ªåŠ¨æ¢æµ‹)

[2] æ ¸å¿ƒç»„ä»¶ç‰ˆæœ¬æ£€æŸ¥ (Version Check)
Java ç‰ˆæœ¬: 1.8.0_472
Python3 ç‰ˆæœ¬: 3.10.12
Kafka/ZK ç›®å½•ä¸å­˜åœ¨ (/usr/local/kafka)
MyCat (æ—¥å¿—æ¨æ–­): æ—¥å¿—ä¸­æœªæ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯
Docker MySQL ç‰ˆæœ¬:
mysql-n2: mysql:5.7
mysql-n1: mysql:5.7

[3] Python å…³é”®ä¾èµ–ç‰ˆæœ¬ (Pip Freeze)
pyspark==4.0.1

[4] æ ¸å¿ƒç«¯å£ç›‘å¬å¤æŸ¥
tcp        0      0 0.0.0.0:5000            0.0.0.0:*               LISTEN      26235/python        
tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      24164/docker-proxy  
tcp        0      0 0.0.0.0:3307            0.0.0.0:*               LISTEN      24417/docker-proxy  
tcp6       0      0 :::8066                 :::*                    LISTEN      24608/java          
tcp6       0      0 :::3306                 :::*                    LISTEN      24170/docker-proxy  
tcp6       0      0 :::3307                 :::*                    LISTEN      24423/docker-proxy  

========== å®¡è®¡ V2.0 ç»“æŸ ==========

```

