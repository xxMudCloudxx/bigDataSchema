# ğŸ“˜ é«˜é€Ÿå…¬è·¯å®æ—¶è½¦æµç›‘æ§å¹³å° - è¿ç»´æ“ä½œæ‰‹å†Œ (A+B+Dç‰ˆ)

æ–‡æ¡£ç‰ˆæœ¬: V1.0

é€‚ç”¨èŒƒå›´: ä»…é™åŒå­¦ A (æ•°æ®æº)ã€B (å­˜å‚¨/ETL)ã€D (åç«¯API) çš„æœåŠ¡è¿ç»´ã€‚

å‰ç½®æ¡ä»¶:

- è¿ç»´äººå‘˜éœ€æ‹¥æœ‰ä¸¤å°æœåŠ¡å™¨çš„ root æƒé™ã€‚
- è„šæœ¬å‡å·²ä¸Šä¼ è‡³æœåŠ¡å™¨å¹¶èµ‹äºˆæ‰§è¡Œæƒé™ (`chmod +x *.sh`)ã€‚

------

## 1. ğŸ—ï¸ æ•´ä½“æ¶æ„ä¸èŠ‚ç‚¹åˆ†å¸ƒ

| **èŠ‚ç‚¹ (Server)** | **IP åœ°å€**                      | **è§’è‰²**       | **éƒ¨ç½²æœåŠ¡ (è´Ÿè´£åŒå­¦)**                                      |
| ----------------- | -------------------------------- | -------------- | ------------------------------------------------------------ |
| **Node 1**        | `pipeline-algo` (112.124.59.217) | è®¡ç®—ä¸æ¶ˆæ¯ä¸­å¿ƒ | Zookeeper, Kafka, Flume, Pythonæ•°æ®æ¨¡æ‹Ÿ (A)   Flink ETL ä»»åŠ¡ (B) |
| **Node 2**        | `db-app` (121.196.226.161)       | å­˜å‚¨ä¸æœåŠ¡ä¸­å¿ƒ | Docker MySQL, MyCat (B)   Flask API (D)                      |

------

## 2. ğŸš¦ å¿«é€Ÿè¿ç»´è„šæœ¬ (è‡ªåŠ¨åŒ–ç®¡ç†)

ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ç³»åˆ— Shell è„šæœ¬ã€‚è¯·ä¼˜å…ˆä½¿ç”¨è¿™äº›è„šæœ¬è¿›è¡Œç®¡ç†ã€‚

### 2.1 çŠ¶æ€æ£€æŸ¥ (Health Check)

| **è„šæœ¬åç§°**      | **éƒ¨ç½²ä½ç½®**    | **åŠŸèƒ½æè¿°**                                                 | **è¿è¡Œå‘½ä»¤**        |
| ----------------- | --------------- | ------------------------------------------------------------ | ------------------- |
| `check_status.sh` | `pipeline-algo` | ä¸€é”®æ£€æŸ¥ ZK, Kafka, Flume, Python æ¨¡æ‹Ÿå™¨çŠ¶æ€åŠæ—¥å¿—è¾“å‡ºã€‚     | `./check_status.sh` |
| `check_db.sh`     | `db-app`        | ä¸€é”®æ£€æŸ¥ MySQL å®¹å™¨, MyCat ç«¯å£, Flask API ç«¯å£åŠæ•°æ®åº“è¿æ¥æ€§ã€‚ | `./check_db.sh`     |

### 2.2 æœåŠ¡é‡å¯/é‡ç½® (Restart/Reset)

| **è„šæœ¬åç§°**         | **éƒ¨ç½²ä½ç½®**    | **åŠŸèƒ½æè¿°**                                                 | **è¿è¡Œå‘½ä»¤**           |
| -------------------- | --------------- | ------------------------------------------------------------ | ---------------------- |
| `reset_pipeline.sh`  | `pipeline-algo` | **[é«˜å±]** å½»åº•åœæ­¢å¹¶æ¸…æ´— Kafka/ZK æ•°æ®ï¼Œé‡ç½® Topicï¼Œé‡å¯æ•´ä¸ªæ•°æ®ç®¡é“ã€‚é€‚ç”¨äºæ•°æ®ç§¯å‹æˆ– Topic æŸååœºæ™¯ã€‚ | `./reset_pipeline.sh`  |
| `restart_backend.sh` | `db-app`        | ä¼˜é›…é‡å¯ Flask åç«¯æœåŠ¡ï¼Œè‡ªåŠ¨æ¿€æ´» venv è™šæ‹Ÿç¯å¢ƒã€‚            | `./restart_backend.sh` |

------

## 3. ğŸ› ï¸ åˆ†è§’è‰²æœåŠ¡å¯åœè¯¦è§£ (æ‰‹åŠ¨æ“ä½œæŒ‡å—)

### ğŸ§‘â€ğŸ’» åŒå­¦ Aï¼šæ•°æ®æºä¸ç®¡é“ (`pipeline-algo`)

**æ ¸å¿ƒç»„ä»¶:** Python Simulator, Flume, Kafka, Zookeeper

#### **å¯åŠ¨é¡ºåº**

1. **Zookeeper**: `/usr/local/zookeeper/bin/zkServer.sh start`

2. **Kafka**: `/usr/local/kafka/bin/kafka-server-start.sh -daemon /usr/local/kafka/config/server.properties`

3. **Flume**:

   Bash

   ```
   nohup /usr/local/flume/bin/flume-ng agent -n a1 -c /usr/local/flume/conf -f /usr/local/flume/jobs/file2kafka.conf -Dflume.root.logger=INFO,console > /usr/local/flume/logs/flume.log 2>&1 &
   ```

4. **Python Simulator**:

   Bash

   ```
   cd ~/datapipe/
   nohup python3 6.simulate.py > simulate.out 2>&1 &
   ```

#### **åœæ­¢æœåŠ¡**

- ä½¿ç”¨ `reset_pipeline.sh` è„šæœ¬å¯ä¸€é”®åœæ­¢æ‰€æœ‰æœåŠ¡ã€‚æ‰‹åŠ¨åœæ­¢å»ºè®®å…ˆæ€ Pythonï¼Œå†åœ Flumeï¼Œæœ€å Kafka/ZKã€‚

#### **éªŒè¯æ–¹æ³•**

- **æŸ¥çœ‹æ¨¡æ‹Ÿæ—¥å¿—**: `tail -f ~/datapipe/simulate.out`

- **æ¶ˆè´¹ Kafka æ•°æ®**:

  Bash

  ```
  /usr/local/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic traffic-raw
  ```

------

### ğŸ§‘â€ğŸ’» åŒå­¦ Bï¼šå­˜å‚¨ä¸ ETL (`db-app` & `pipeline-algo`)

**æ ¸å¿ƒç»„ä»¶:** MyCat, Docker MySQL, Flink

#### **å­˜å‚¨å±‚å¯åœ (`db-app`)**

1. **Docker MySQL (ç‰©ç†åº“)**
   - **å¯åŠ¨**: `docker start mysql-n1 mysql-n2`
   - **åœæ­¢**: `docker stop mysql-n1 mysql-n2`
   - **æŸ¥çœ‹çŠ¶æ€**: `docker ps`
2. **MyCat (ä¸­é—´ä»¶)**
   - **å¯åŠ¨**: `/usr/local/mycat/bin/mycat start`
   - **åœæ­¢**: `/usr/local/mycat/bin/mycat stop`
   - **é‡å¯**: `/usr/local/mycat/bin/mycat restart`
   - **éªŒè¯**: `netstat -ntlp | grep 8066`

#### **è®¡ç®—å±‚å¯åœ (`pipeline-algo`)**

1. **Flink Cluster**

   - **å¯åŠ¨**: `/usr/local/flink/bin/start-cluster.sh`
   - **åœæ­¢**: `/usr/local/flink/bin/stop-cluster.sh`

2. **æäº¤ ETL ä»»åŠ¡ (Kafka -> MyCat)**

   Bash

   ```
   /usr/local/flink/bin/flink run -d -c com.traffic.job.KafkaToMyCatJob /home/student_b/TrafficMonitor-1.0-SNAPSHOT.jar
   ```

#### **ğŸ” MyCat æ•°æ®æŸ¥è¯¢æŒ‡å— (é‡ç‚¹)**

ç”±äºå®¿ä¸»æœºç¯å¢ƒé™åˆ¶ï¼Œå»ºè®®é€šè¿‡ Docker å®¹å™¨å†…çš„ MySQL å®¢æˆ·ç«¯è¿æ¥ MyCat è¿›è¡ŒéªŒè¯ã€‚

**æŸ¥è¯¢å‘½ä»¤:**

Bash

```
# è¿æ¥ MyCat (ç«¯å£ 8066) æŸ¥è¯¢æ•°æ®æ€»é‡
docker exec -it mysql-n1 mysql -h 172.17.0.1 -P 8066 -u root -p123456 -D MYETCDB -e "SELECT count(*) FROM traffic_data;"
```

- `172.17.0.1` æ˜¯å®¿ä¸»æœºçš„ Docker ç½‘æ¡¥ IPã€‚
- å¦‚æœè¿”å›æ•°å­—ä¸”åœ¨å¢é•¿ï¼Œè¯´æ˜æ•°æ®æµæ­£å¸¸ã€‚

------

### ğŸ§‘â€ğŸ’» åŒå­¦ Dï¼šåç«¯ API (`db-app`)

**æ ¸å¿ƒç»„ä»¶:** Flask

#### **å¯åŠ¨æœåŠ¡**

æ¨èä½¿ç”¨ `restart_backend.sh`ã€‚æ‰‹åŠ¨å¯åŠ¨æ­¥éª¤å¦‚ä¸‹ï¼š

Bash

```
cd /home/student_d/backend/
source venv/bin/activate  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
nohup python app_B.py > flask.log 2>&1 &
```

#### **åœæ­¢æœåŠ¡**

Bash

```
# æŸ¥æ‰¾è¿›ç¨‹ PID
ps -ef | grep app_B.py
# å¼ºåˆ¶ç»ˆæ­¢
kill -9 <PID>
```

#### **éªŒè¯æ–¹æ³•**

- **æŸ¥çœ‹æ—¥å¿—**: `tail -f /home/student_d/backend/flask.log`

- **æµ‹è¯•æ¥å£**:

  Bash

  ```
  curl http://127.0.0.1:5000/api/stats/kkmc_count
  ```

  *åº”è¿”å› JSON æ ¼å¼çš„æ•°æ®ã€‚*

------

## 4. ğŸš¨ å¸¸è§é—®é¢˜ä¸æ’æŸ¥ (FAQ)

**Q1: Kafka æ— æ³•å¯åŠ¨æˆ–æŠ¥é”™ "Configured broker.id ... doesn't match"**

- **åŸå› **: `meta.properties` æ–‡ä»¶ä¸­çš„ broker.id ä¸é…ç½®ä¸ç¬¦ã€‚
- **è§£å†³**: è¿è¡Œ `reset_pipeline.sh`ï¼Œå®ƒä¼šæ¸…é™¤æ—§æ•°æ®ç›®å½•å¹¶é‡å»ºç¯å¢ƒã€‚

**Q2: MyCat è¿ä¸ä¸Š (Connection refused)**

- **æ’æŸ¥**:
  1. è¿è¡Œ `check_db.sh` æ£€æŸ¥ 8066 ç«¯å£æ˜¯å¦ç›‘å¬ã€‚
  2. æ£€æŸ¥ `wrapper.log` (`/usr/local/mycat/logs/wrapper.log`) æ˜¯å¦æœ‰æŠ¥é”™ã€‚
  3. ç¡®è®¤åç«¯ Docker å®¹å™¨ (`mysql-n1`, `mysql-n2`) æ˜¯å¦è¿è¡Œä¸­ã€‚

**Q3: Flink ä»»åŠ¡æäº¤å¤±è´¥**

- **æ’æŸ¥**: æ£€æŸ¥ `pipeline-algo` çš„ `/usr/local/flink/log/` ä¸‹çš„æ—¥å¿—ã€‚å¸¸è§åŸå› æ˜¯æ— æ³•è¿æ¥ MyCat (æ£€æŸ¥ `db-app` é˜²ç«å¢™) æˆ– Kafka Topic ä¸å­˜åœ¨ã€‚

**Q4: Flask æŠ¥é”™ "Address already in use"**

- **åŸå› **: ç«¯å£ 5000 è¢«å ç”¨ã€‚
- **è§£å†³**: è¿è¡Œ `restart_backend.sh`ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¹¶æ€æ­»å ç”¨ç«¯å£çš„æ—§è¿›ç¨‹ã€‚